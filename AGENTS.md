# AGENTS.md - AI Agent Guide for Papo

## Project Overview

**Papo** is an unofficial GTK4/Libadwaita client for WhatsApp Web, built with Rust. "Papo" is Brazilian Portuguese slang for "chat" or "conversation."

- **App ID**: `com.amanoteam.Papo`
- **License**: Apache-2.0
- **Repository**: https://github.com/AmanoTeam/Papo
- **Primary Forge**: https://git.amanoteam.com/AmanoTeam/Papo (accepts PRs from both)

## Technology Stack

### Core Framework
- **Language**: Rust (Edition 2024, requires nightly toolchain)
- **GUI Framework**: [Relm4](https://relm4.org/) 0.10 - idiomatic GTK4 bindings for Rust
- **UI Toolkit**: GTK4 (>= 4.20) + Libadwaita (>= 1.8) for GNOME-style interfaces
- **Build System**: Meson (primary) + Cargo (Rust dependencies)

### Key Dependencies
- `whatsapp-rust` - WhatsApp Web API implementation (external git dependency)
- `libsql` 0.9 - Local SQLite database with optional encryption
- `tokio` - Async runtime
- `relm4-icons` - Icon handling
- `glycin` 3.0 - Image loading/decoding
- `qrcode` - QR code generation for login
- `gettext-rs` - Internationalization (i18n)

### System Dependencies
- glib-2.0 (>= 2.82)
- gio-2.0 (>= 2.82)
- gtk4 (>= 4.20.2)
- libadwaita-1 (>= 1.8.0)
- glycin-2 (>= 2.0.0)
- openssl (>= 3.0.0)
- sqlite3 (>= 3.24.0)
- libwebp (>= 1.0.0)

## Project Structure

```
src/
├── main.rs           # Entry point, logging, i18n setup
├── application.rs    # Main app component (AsyncComponent), state management
├── config.rs         # Build-time constants (generated by meson)
├── utils.rs          # Utility functions
├── components/       # UI components (Relm4 components)
│   ├── chat_list.rs  # Chat list sidebar
│   ├── chat_view.rs  # Message conversation view
│   └── login.rs      # QR code/phone login component
├── modals/           # Dialog windows
│   ├── about.rs      # About dialog
│   └── shortcuts.rs  # Keyboard shortcuts dialog
├── session/          # WhatsApp client session management
│   ├── client.rs     # WhatsApp client wrapper (async actor)
│   └── cache.rs      # Runtime and render caches
├── state/            # Data models
│   ├── chat.rs       # Chat model
│   ├── message.rs    # Message model
│   └── media.rs      # Media attachment model
├── store/            # Persistence layer
│   └── database.rs   # libSQL database operations
└── widgets/          # Custom GTK widgets

data/                 # Desktop files, schemas, metainfo
po/                   # Translations (gettext)
build-aux/            # Flatpak manifests
```

## Architecture Patterns

### Component-Based Architecture (Relm4)
The app uses Relm4's async component pattern:
- `Application` - Root component managing app state
- `Client` - Async actor handling WhatsApp connection
- `Login`, `ChatList` - Sub-components with their own state

### State Management
- **App State**: `AppState` enum (Loading, Ready, Pairing, Syncing, Disconnected, Error)
- **Pages**: `AppPage` enum (Loading, Login, Session, Error)
- **Session Pages**: `AppSessionPage` enum (Empty, Chat)

### Data Flow
1. WhatsApp events → `Client` component → `Application` messages
2. UI actions → Component outputs → `Application` messages
3. State changes trigger UI updates via Relm4's reactive view macros

### Caching Strategy
- `RenderCache` - UI render cache for chat/message lists (avoids recomputation)
- `RuntimeCache` - WhatsApp data cache (participant info, media, etc.)
- Database persistence via libSQL

## Build Instructions

### Development Build
```bash
meson setup _build
meson compile -C _build
meson install -C _build
```

### Flatpak Build
```bash
flatpak-builder --install --user build build-aux/com.amanoteam.Papo.json
```

### Nix
```bash
nix build github:AmanoTeam/Papo
nix run github:AmanoTeam/Papo
```

## Code Style & Conventions

### Rust Configuration
- **Clippy**: Very strict linting enabled (see `main.rs` deny attributes)
- **Formatting**: rustfmt with standard style
- **Pre-commit hook**: Automatically installed in dev profile (`hooks/pre-commit.hook`)

### Key Lint Rules (from main.rs)
```rust
#![deny(clippy::all)]
#![deny(clippy::cargo)]
#![deny(clippy::pedantic)]
#![deny(clippy::use_self)]
#![deny(clippy::print_stdout)]  // Use tracing instead
#![deny(clippy::print_stderr)]  // Use tracing instead
```

### Patterns to Follow
1. **Use `tracing`** for all logging (never `println!`/`eprintln!`)
2. **Use `self`** when referring to own type (enforced by clippy)
3. **Avoid redundant clones** (enforced by clippy)
4. **Prefer `expect` over `unwrap`** for initialization errors
5. **Use the i18n macros**: `i18n!()`, `i18n_f!()`, `ni18n!()` for all user-facing strings

### Internationalization
- All user-visible strings must use gettext macros
- Translation files in `po/` directory
- Brazilian Portuguese (pt_BR) currently supported
- Template generation via meson/i18n

## Common Tasks

### Adding a New Component
1. Create file in `src/components/` or appropriate subdirectory
2. Implement `AsyncComponent` or `Component` trait from Relm4
3. Define `Init`, `Input`, `Output`, `Widgets` types
4. Use `view!` macro for declarative UI
5. Export in `mod.rs`
6. Wire into parent component via `builder().launch().forward()`

### Adding Database Operations
1. Add methods to `src/store/database.rs`
2. Use `libsql` async API
3. Handle errors with `tracing::error!()`
4. Update models in `src/state/` as needed

### Handling WhatsApp Events
1. Events flow through `Client` component in `src/session/client.rs`
2. Convert to `ClientOutput` enum variants
3. Forward to `Application` which dispatches to appropriate handlers
4. Update state and trigger UI updates

### Adding UI Breakpoints (Responsive)
Use Adwaita breakpoints in the view macro:
```rust
add_breakpoint = bp_with_setters(
    adw::Breakpoint::new(
        adw::BreakpointCondition::new_length(
            adw::BreakpointConditionLengthType::MaxWidth,
            600.0,
            adw::LengthUnit::Sp,
        )
    ),
    &[(&split_view, "collapsed", true)]
),
```

## Important Notes

### WhatsApp Library
- Uses `whatsapp-rust` from https://github.com/jlucaso1/whatsapp-rust
- Pinned to specific git revision in `Cargo.toml`
- Handles WhatsApp Web protocol, encryption, and messaging

### Async Runtime
- Tokio runtime is used for async operations
- Relm4 has its own async task handling
- Database operations are async via libsql

### Thread Safety
- `Arc<Database>` shared across components
- `Arc<RuntimeCache>` for shared runtime data
- GTK UI updates must happen on main thread (Relm4 handles this)

### Data Directory
- App data stored at `~/.local/share/papo/` (Linux)
- Database file: `papo.db` in data directory
- Access via `DATA_DIR` static in `main.rs`

## Testing

- Tests run via `meson test` or `cargo test`
- Flatpak manifest includes test-args for X11/network access
- No comprehensive test suite yet (contributions welcome)

## Roadmap Context

Current implemented features:
- QR code login
- Chat list with infinite scroll pagination
- Message history with bidirectional infinite scroll
- Read receipts
- Local message storage (libSQL)

Major pending features:
- Send messages
- Media messages (images, videos, documents)
- Notifications
- Message reactions
- Reply/quote messages
- Database encryption

When implementing features, check the roadmap in README.md for priority and context.

## Troubleshooting

### Build Issues
- Ensure Rust nightly is installed (see `rust-toolchain.toml`)
- GTK4/Libadwaita development headers must be installed
- Meson version >= 0.59 required

### Runtime Issues
- Check `RUST_LOG` environment variable for logging control
- Default: `papo=info,warn`
- Use `papo=trace` for verbose WhatsApp protocol debugging

### Database Issues
- Database is SQLite at `~/.local/share/papo/papo.db`
- Can inspect with standard SQLite tools
- Schema managed in `src/store/database.rs`
